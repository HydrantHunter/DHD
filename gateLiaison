--[[ Stargate/Shield   ]]--
--[[     Liaison       ]]--
--[[  version 0.6.1.1  ]]--
--[[ by HydrantHunter  ]]--
--[[     aka Dog       ]]--
--[[ pastebin xSHHqL0h ]]--

--[[
Tested with/requires:
  - Mincraft 1.6.4
  - Latest DeltaSG-Craft or LanteaCraft (snapshot 82)
  - ComputerCraft ver. 1.57+ for MC 1.6.4
    - HTTP API enabled
    - 1 Advanced Computer (color, mouse), 3 optional Advanced Monitors (color)
    - DHD running on an Advanced Computer with 4 optional Advanced Monitors

  - DHD also supports GopherATL's BioLock ver. 2.1.3 (updated for 1.6.4 by gamax92)
]]--

--[[
    To Do:
  -- High priority
      - add auto-detect routines for peripherals
      - fix double send on activity
      - fix no YY sent after allclear received
  -- Low priority
      - try modem wrap and experiment with chan.send & chan.recv
]]--

-- MANUAL CONFIGURATION
-- Gate & Shield
local gate = peripheral.wrap("top")  -- Stargate
local shield = "bottom"              -- Side for redstone output
local gateControl = 1                -- DHD Computer
local pollTime = 5                   -- Number of seconds between status polls
-- Monitor
local mon = peripheral.wrap("monitor_0") -- Monitor (3xAdvanced) - set to "none" if no monitor
-- Network
rednet.open("front")
--local IO = peripheral.wrap("right")
--local chan = { send = 229, rec = 231 }
-- END MANUAL CONFIGURATION

-- AUTOMATIC/STATIC CONFIGURATION (Part 1)
local dialStatus = gate.isDialing()
local connectStatus = gate.isConnected()
local dialAddress = "none"
local gateStatus = "QRY"
local pData
local currentState = "ZZ"
local fuelGuage = gate.hasFuel()
--local connectTimer = 0
local pollTimer = 0
local timePoller = 0
local thisGate = gate.getAddress()
local longName = ""
local shieldStatus
-- END AUTOMATIC/STATIC CONFIGURATION (Part 1)

local function displayMarque()
  if mon ~= "none" then
    mon.clear()
    mon.setTextScale(2)
    mon.setCursorPos(1,1)
    mon.setTextColor(colors.cyan)
    mon.write("Stargate")
    mon.setCursorPos(2,2)
    mon.setTextColor(colors.yellow)
    mon.write(longName)
  end
end

local function drawTermScreen()
  term.setBackgroundColor(colors.black)
  term.clear()
  term.setBackgroundColor(colors.blue)
  term.setTextColor(colors.white)
  term.setCursorPos(2,2)
  term.write(" Gate Liaison  ver. 0.6.1.1 ")
  term.setCursorPos(2,10)
  term.write("                            ")
  term.setCursorPos(2,10)
  term.write(" " .. os.getComputerLabel())
  local cID = tostring(math.floor(os.getComputerID()))
  term.setCursorPos(30-(3+#cID),10)
  term.write("# " .. cID)
  term.setBackgroundColor(colors.lightGray)
  term.setTextColor(colors.black)
  for i = 2,14,1 do
    for j = 3,9,1 do
      term.setCursorPos(i,j)
      term.write(" ")
    end
  end
  term.setCursorPos(2,3)
  term.write(" Gate:")
  term.setCursorPos(2,4)
  term.write(" State:")
  term.setCursorPos(2,5)
  term.write(" Target:")
  term.setCursorPos(2,6)
  term.write(" Shield:")
  term.setCursorPos(2,7)
  term.write(" Fuel:")
  term.setCursorPos(2,8)
  term.write(" Status:")
  term.setCursorPos(2,9)
  term.write(" ccDHD:")
  term.setBackgroundColor(colors.black)
  term.setTextColor(colors.yellow)
  term.setCursorPos(17,3)
  term.write(thisGate)
  term.setCursorPos(17,4)
  if gateStatus == "Disconnected" then
    term.setTextColor(colors.green)
  else
    term.setTextColor(colors.orange)
  end
  term.write(gateStatus)
  term.setCursorPos(17,5)
  term.setTextColor(colors.brown)
  term.write(dialAddress)
  term.setCursorPos(17,6)
  if shieldStatus == true then
    term.setTextColor(colors.green)
    term.write("ON ")
  elseif shieldStatus == false then
    term.setTextColor(colors.orange)
    term.write("OFF")
  else
    term.write("ERR")
  end
  term.setCursorPos(17,7)
  if fuelGuage == true then
    term.setTextColor(colors.green)
    term.write("Yes")
  elseif fuelGuage == false then
    term.setTextColor(colors.red)
    term.write("NO")
  else
    term.setTextColor(colors.magenta)
    term.write("ERROR")
  end
  term.setCursorPos(17,8)
  term.setTextColor(colors.lightBlue)
  term.write(pData)
  term.setCursorPos(17,9)
  term.setTextColor(colors.lightGray)
  term.write(gateControl)
end

local function updateStatus()
  currentState = pData
  connectStatus = gate.isConnected()
  dialStatus = gate.isDialing()
  fuelGuage = gate.hasFuel()
  shieldStatus = rs.getOutput(shield)
  if gateStatus == "allclear" then
    pData = "YY"
    rednet.send(gateControl,pData,true)
    gateStatus = "Disconnected"
    dialAddress = "none"
  elseif gateStatus == "lockdown" then
    pData = "XX"
    dialAddress = "none"
    rednet.send(gateControl,pData,true)
    return
  end
  if shieldStatus == true then
    pData = "1"
  else
    pData = "0"
  end
  if tostring(connectStatus) == "true" then
    pData = pData .. "1"
    gateStatus = "Connected"
    if mon ~= "none" then
      mon.clear()
      mon.setTextScale(2)
      mon.setCursorPos(1,1)
      mon.setTextColor(colors.lightBlue)
      if dialAddress ~= "none" then
        mon.write("Connected to")
        mon.setTextColor(colors.yellow)
        mon.setCursorPos(1,2)
        local dA = {}
        for i = 1,#dialAddress do
          dA[i] = dialAddress:sub(i,i)
          mon.write(" " .. dA[i])
        end
      else
        mon.write("Connected")
      end
    end
  elseif tostring(connectStatus) == "false" then
    if gateStatus == "Dialing" or tostring(dialStatus) == "true" then
      pData = pData .. "2"
      if mon ~= "none" then
        mon.clear()
        mon.setTextScale(2)
        mon.setCursorPos(1,1)
        mon.setTextColor(colors.lightBlue)
        mon.write("Dialing")
        mon.setTextColor(colors.yellow)
        mon.setCursorPos(1,2)
        local dA = {}
        for i = 1,#dialAddress do
          dA[i] = dialAddress:sub(i,i)
          mon.write(" " .. dA[i])
        end
      end
    end
    if gateStatus ~= "Dialing" and tostring(dialStatus) == "false" and gateStatus ~= "lockdown" and gateStatus ~= "allclear" then
      if tostring(connectStatus) == "false" then
        gateStatus = "Disconnected"
        dialAddress = "none"
        pData = pData .. "0"
      else
        gateStatus = "Connected"
        pData = pData .. "1"
      end
    end
  end
  if gateStatus ~= "Dialing" and gateStatus ~= "Connected" and gateStatus ~= "lockdown" then displayMarque() end
  if pData == "YY" then
    shieldState = false
    gateStatus = "Disconnected"
    dialAddress = "none"
  end
  --if currentState ~= pData then rednet.send(gateControl,pData,true) end  - doesn't work for "QRY" - fix that and it's golden
  rednet.send(gateControl,pData,true)
  if currentState ~= pData then
    drawTermScreen()
    --rednet.send(gateControl,pData,true)
  end
end

local function recordSessionData()  -- Human readable log files (last gate & history)
  local dateStamp = textutils.formatTime(os.time(),false) .. " / Day " .. os.day()
  local lastGate = fs.open("/logs/DHDlast","w")
  lastGate.writeLine(dateStamp)
  lastGate.writeLine(dialAddress)
  lastGate.close()
  local gateArchive = fs.open("/logs/DHDhistory","a")
  gateArchive.writeLine(dateStamp)
  gateArchive.writeLine(dialAddress)
  gateArchive.close()
end

local function shieldControl(state)
  if state == "ON" then
    rs.setOutput(shield,true)
  elseif state == "OFF" then
    rs.setOutput(shield,false)
  else
    rs.setOutput(shield,true)
  end
  updateStatus()
end

local function lockDown()
  gateStatus = "lockdown"
  shieldControl("ON")
  gate.disconnect()
  dialAddress = "none"
  updateStatus()
  if mon ~= "none" then
    mon.clear()
    mon.setCursorPos(1,1)
    mon.setTextColor(colors.red)
    mon.write("!! LOCKDOWN !!")
  end
end

local function dialOut(targetAddress)
  dialAddress = tostring(targetAddress)
  connectStatus = gate.isConnected()
  if dialAddress ~= thisGate and tostring(connectStatus) == "false" then -- Is the stargate connected to another stargate?  isConnected()
    local dialNow = gate.dial(dialAddress)
      updateStatus()
    if tostring(dialNow) == "true" then
      gateStatus = "Dialing"
      recordSessionData()
      updateStatus()
      return true
    elseif tostring(dialNow) == "false" then
      return false
    end
  else
    return false
  end
end

local function endCall()
  gate.disconnect()
  sleep(0.5)
  if tostring(gate.isConnected()) == "false" then
    gateStatus = "Disconnected"
    dialAddress = "none"
  end
  updateStatus()
end

local function doCommand(thisCommand)
  if thisCommand == "lockdown" then
    lockDown()
  end
  if thisCommand == "QRY" then
    updateStatus()
    if fuelGuage == true then
      rednet.send(gateControl,"gas",true)
    elseif fuelGuage == false then
      rednet.send(gateControl,"nogas",true)
    end
    return
  elseif thisCommand == "1stRun" then
    rednet.send(gateControl,thisGate,true)
    return
  elseif thisCommand == "allclear" then
    displayMarque()
    shieldControl("OFF")
    gateStatus = "allclear"
    dialAddress = "none"
    --gateStatus = "Disconnected"
    --rednet.send(gateControl,thisCommand,true)
    updateStatus()
    return -- ?
  end                                  -- replaced elseif with end/if - split these into two if/thens
  if gateStatus ~= "lockdown" then
    dialAddress = "none"
    if thisCommand == "endCall" then
      endCall()
    elseif thisCommand == "sON" then
      shieldControl("ON")
    elseif thisCommand == "sOFF" then
      shieldControl("OFF")
    elseif thisCommand == "restart" or thisCommand == "reset" then
      os.reboot()
    else
      if thisCommand:len() > 6 and thisCommand:len() < 10 and thisCommand ~= "endCall" and thisCommand ~= "lockdown" and thisCommand ~= "allclear" then
        if fuelGuage == true then
          rednet.send(gateControl,"gas",true)
        elseif fuelGuage == false then
          rednet.send(gateControl,"nogas",true)
        end
        if dialOut(thisCommand) == false then
          gateStatus = "Disconnected"
          dialAddress = "none"
        else
          gateStatus = "Dialing"
        end
      end
    end
  end
  updateStatus()
end

local function netReceive()
  while true do
    eventNet = {rednet.receive()}
    if tonumber(eventNet[1]) == gateControl then
      if eventNet[2] ~= nil and eventNet[2] ~= "" then doCommand(eventNet[2]) end
      --return(eventNet[2])
    --elseif eventNet[1] == "modem_message" and tonumber(eventNet[4]) == gateControl then
      --doCommand(eventNet[5])
     end
  end
end

local function dataPoller()
  while true do
    local timerEvent = { os.pullEvent("timer") }
    if timerEvent[2] == pollTimer then
      timePoller = 0
      updateStatus()
      break
    end
  end
end

local function gateKernel()
  if timePoller == 0 then
    pollTimer = os.startTimer(pollTime)
    timerPoller = 1
  end
  parallel.waitForAny(netReceive,dataPoller)
end

-- AUTOMATIC/STATIC CONFIGURATION (Part 2)
local function initMe()
  if mon ~= "none" then
    mon.setTextScale(2)
    mon.setBackgroundColor(colors.black)
    mon.setTextColor(colors.cyan)
  end
  --local sCommandOptions = { "QRY" "sON" "sOFF" "lockdown" "allclear" "reboot" "reset" }
  --thisGate = gate.getAddress()
  local tG = {}
  longName = ""
  for i = 1,thisGate:len(),1 do
    tG[i] = thisGate:sub(i,i)
    if i < thisGate:len() then
      longName = longName .. tG[i] .. " "
    else
      longName = longName .. tG[i]
    end
  end
  rs.setOutput(shield,false)
  sleep(0.5)
  rs.setOutput(shield,true)
  shieldStatus = true
end
-- END AUTOMATIC/STATIC CONFIGURATION (Part 2)

initMe()
displayMarque()
updateStatus()

while true do
  gateKernel()
end
